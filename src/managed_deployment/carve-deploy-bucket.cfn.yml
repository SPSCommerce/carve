AWSTemplateFormatVersion: "2010-09-09"
Description: Regional S3 Deploy Bucket for Carve

Parameters:
  OrganizationsId:
    Type: String
    Description: AWS Organizations Id
    Default: ""
  UniqueId:
    Type: String
    Description: A unique string for S3 buckets. If none, will use AWS Organizations Id
    Default: ""
  ResourcePrefix:
    Type: String
    Description: "Prefix all carve resources with this"
    Default: ""
  CarveCoreRegion:
    Type: String
    Default: us-east-1


Conditions:
  CoreRegion: !Equals 
    - !Ref "AWS::Region"
    - !Ref "CarveCoreRegion"

Resources:
  CarveS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${ResourcePrefix}carve-managed-bucket-${OrganizationsId}-${AWS::Region}"
      AccessControl: Private
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'AES256'

  CarveS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CarveS3Bucket
      PolicyDocument:
        Statement:
          - Sid: CarveCoreLambda
            Effect: Allow 
            Action:
              - "s3:*"
            Resource: !GetAtt CarveS3Bucket.Arn
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:role/${ResourcePrefix}carve-lambda-${OrganizationsId}"
          - Sid: DeploymentAccess
            Effect: Allow 
            Action:
              - "s3:Get*"
              - "s3:PutObject"
            Resource: 
              - !Sub "arn:aws:s3:::${CarveS3Bucket}"
              - !Sub "arn:aws:s3:::${CarveS3Bucket}/*"
            Principal:
              AWS: "*"
            Condition:
              StringEquals:
                aws:PrincipalOrgID: !Ref OrganizationsId

  S3InvokeCarvePermission:
    Type: AWS::Lambda::Permission
    Condition: CoreRegion
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ResourcePrefix}carve-${OrganizationsId}"
      Principal: s3.amazonaws.com
      SourceArn: !GetAtt CarveS3Bucket.Arn
