{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters": {
      "DeployBucket": {
        "Default": "carve-deploy",
        "Description": "bucket name",
        "Type": "String"
      },
      "OrganizationsId": {
        "Type": "String",
        "Description": "AWS Organizations Id",
        "Default": ""
      },
      "CarveStackPrefix": {
        "Type": "String",
        "Description": "Prefix all carve stack names with this",
        "Default": ""
      },
      "GitHubOAUTHTokenASMPath": {
        "Default": "githuboauthtoken",
        "Description": "GitHubServiceOAUTHToken path in Secrets Manager",
        "Type": "String"
      }
    },
    "Resources": {
      "CarvePipelineRole": {
        "Type": "AWS::IAM::Role",
        "Properties": {
          "RoleName": "carve-deploy-pipeline",
          "AssumeRolePolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": [
                    "codepipeline.amazonaws.com", 
                    "cloudformation.amazonaws.com"
                  ]
                },
                "Action": "sts:AssumeRole"
              }
            ]
          },
          "Policies": [
            {
              "PolicyName": "CodePipelineServiceRole",
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Sid": "CloudWatchLogsPolicy",
                    "Effect": "Allow",
                    "Action": [
                      "logs:CreateLogGroup",
                      "logs:CreateLogStream",
                      "logs:PutLogEvents",
                      "logs:PutRetentionPolicy",
                      "logs:DeleteLogGroup"
                    ],
                    "Resource": [
                      "*"
                    ]
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "codebuild:StartBuild",
                      "codebuild:BatchGetBuilds"
                    ],
                    "Resource": [
                      { "Fn::Sub": "arn:aws:codebuild:${AWS::Region}:${AWS::AccountId}:project/CarveCodeBuild" }
                    ]
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "*"
                    ],
                    "Resource": [
                      "*"
                    ]
                  }
                ]
              }
            }
          ]
        }
      },
      "CarveDeploymentPipeline": {
        "Type": "AWS::CodePipeline::Pipeline",
        "Properties": {
          "Name": "CarveDeploymentPipeline",
          "RoleArn": { "Fn::GetAtt" : [ "CarvePipelineRole", "Arn" ] },
          "ArtifactStore": {
              "Location": { "Ref": "DeployBucket" },
              "Type": "S3"
            },
          "Stages": [
            {
              "Name" : "CarveSource",
              "Actions" : [
                  {
                    "Name" : "SourceAction",
                    "Namespace": "github_vars",
                    "ActionTypeId" : {
                      "Category" : "Source",
                      "Owner" : "ThirdParty",
                      "Provider" : "GitHub",
                      "Version" : 1
                    },
                    "OutputArtifacts" : [ { "Name" : "GithubRepo" } ],
                    "Region" : { "Ref": "AWS::Region" },
                    "Configuration": {
                      "Owner": "anotherhobby",
                      "Repo": "carve",
                      "Branch": "main",
                      "OAuthToken": {"Fn::Sub": "{{resolve:secretsmanager:${GitHubOAUTHTokenASMPath}:SecretString:token}}"}
                    }
                  }
              ]
            },
            {
              "Name" : "UpdateCarvePipeline",
              "Actions" : [
                {
                  "ActionTypeId" : {
                    "Category" : "Deploy",
                    "Owner" : "AWS",
                    "Provider" : "CloudFormation",
                    "Version" : 1
                  },
                  "Name" : "update-carve-pipeline",
                  "Configuration": {
                    "ChangeSetName": "pipeline-changeset",
                    "ActionMode": "CREATE_UPDATE",
                    "Capabilities": "CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND",
                    "RoleArn":  { "Fn::GetAtt": [ "CarvePipelineRole", "Arn" ] },
                    "StackName": "carve-pipeline",
                    "TemplatePath": "GithubRepo::deployment/codepipeline/codepipeline.cfn.json"
                  },
                  "OutputArtifacts": [],
                  "InputArtifacts": [ { "Name" : "GithubRepo" } ]
                }
              ]
            },
            {
              "Name" : "PackageLambda-DeployIAM",
              "Actions" : [
                  {
                    "ActionTypeId" : {
                      "Category" : "Build",
                      "Owner" : "AWS",
                      "Provider" : "CodeBuild",
                      "Version" : 1
                    },
                    "Name" : "carve-lambda-packaging",
                    "InputArtifacts" : [ { "Name" : "GithubRepo" } ],
                    "Region" : { "Ref": "AWS::Region" },
                    "Configuration": {
                      "ProjectName": { "Ref": "CarveCodeBuild"},
                      "EnvironmentVariables": "[{\"name\":\"GITSHA\",\"value\":\"#{github_vars.CommitId}\",\"type\":\"PLAINTEXT\"}]"
                    }
                  },
                  {
                  "Name": "carve-iam-stackset-deploy",
                  "Region": { "Ref": "AWS::Region"},
                  "ActionTypeId": {
                      "Category": "Deploy",
                      "Owner": "AWS",
                      "Provider": "CloudFormationStackSet",
                      "Version": 1
                  },
                  "Configuration": {
                      "Capabilities": "CAPABILITY_IAM,CAPABILITY_NAMED_IAM",
                      "OrganizationsAutoDeployment": "Enabled",
                      "Description": "Carve IAM Role Required in all AWS Accounts",
                      "DeploymentTargets": { "Ref": "OrganizationsId"},
                      "Regions": { "Ref": "AWS::Region"},
                      "FailureTolerancePercentage": 100, 
                      "MaxConcurrentPercentage": 100,
                      "PermissionModel": "SERVICE_MANAGED",
                      "StackSetName": {"Fn::Sub": "${CarveStackPrefix}carve-lambda-${OrganizationsId}"},
                      "TemplatePath": "GithubRepo::deployment/carve-iam.cfn.yml",
                      "Parameters": {"Fn::Sub": "[{ParameterKey=Version,ParameterValue=#{github_vars.CommitId}},{Parameter=OrganizationsId,ParameterValue=${OrganizationsId}]"}
                  },
                  "OutputArtifacts": [],
                  "InputArtifacts": [ { "Name" : "GithubRepo" } ]
              }
              ]
            },
            {
              "Name" : "CarveCoreDeploy",
              "Actions" : [
                {
                  "ActionTypeId" : {
                    "Category" : "Deploy",
                    "Owner" : "AWS",
                    "Provider" : "CloudFormation",
                    "Version" : 1
                  },
                  "Name" : "carve-deployment",
                  "Configuration": {
                    "ChangeSetName": "pipeline-changeset",
                    "ActionMode": "CREATE_UPDATE",
                    "Capabilities": "CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND",
                    "RoleArn":  { "Fn::GetAtt": [ "CarvePipelineRole", "Arn" ] },
                    "StackName": { "Fn::Sub": "${CarveStackPrefix}carve-core-${OrganizationsId}" },
                    "TemplatePath": "GithubRepo::deployment/carve-core.cfn.yml",
                    "ParameterOverrides": {"Fn::Sub": "{\"GITSHA\": \"#{github_vars.CommitId}\", \"OrganizationsId\": \"${OrganizationsId}\", \"CodeBucket\": \"${DeployBucket}\"}"}
                  },
                  "OutputArtifacts": [],
                  "InputArtifacts": [ { "Name" : "GithubRepo" } ]
                }
              ]
            }
          ]
        }
      },
      "CarveCodeBuild": {
        "Type": "AWS::CodeBuild::Project",
        "Properties": {
          "Artifacts": {
            "Type": "CODEPIPELINE"
          },
          "Name": "CarveCodeBuild",
          "ServiceRole": {"Fn::GetAtt": ["CarveCodeBuildRole","Arn"]},
          "Environment": {
            "Type": "LINUX_CONTAINER",
            "ComputeType": "BUILD_GENERAL1_SMALL",
            "Image": "aws/codebuild/python:3.7.1",
            "PrivilegedMode": true,
            "EnvironmentVariables": [
              {
                "Name": "DEPLOYMENT_BUCKET",
                "Value": {"Ref": "DeployBucket"}
              },
              {
                "Name": "GIT_TOKEN",
                "Value": {"Ref":"GitHubOAUTHTokenASMPath"}
              }
            ]
          },
          "Source": {
            "Type": "CODEPIPELINE",
            "BuildSpec": "deployment/codepipeline/pipeline_buildspec.yml"
            },
          "TimeoutInMinutes": 5,
          "Tags": [
            {
              "Key": "GitSHA",
              "Value": "0"
            }
          ]
        }
      },
      "CarveCodeBuildRole": {
        "Type": "AWS::IAM::Role",
        "Properties": {
          "RoleName": "carve-deploy-codebuild",
          "AssumeRolePolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "codebuild.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          },
          "Policies": [
            {
              "PolicyName": "CodeBuildServiceRoleV2",
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Sid": "CloudWatchLogsPolicy",
                    "Effect": "Allow",
                    "Action": [
                      "logs:CreateLogGroup",
                      "logs:CreateLogStream",
                      "logs:PutLogEvents"
                    ],
                    "Resource": [
                      "*"
                    ]
                  },
                  {
                    "Sid": "DeployPolicy",
                    "Effect": "Allow",
                    "Action": [
                      "ssm:*",
                      "secretsmanager:*",
                      "kms:Decrypt"
                    ],
                    "Resource": [
                      "*"
                    ]
                  },
                  {
                    "Sid": "S3Policy",
                    "Effect": "Allow",
                    "Action": [
                      "s3:*"
                    ],
                    "Resource": [
                        { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "DeployBucket" } , "/*" ]]},
                        { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "DeployBucket" }]]}
                    ]
                  },
                  {
                    "Sid": "iampolicy",
                    "Effect": "Allow",
                    "Action": [
                      "iam:PassRole"
                    ],
                    "Resource": [
                      "*"
                    ]
                  }
                ]
              }
            }
          ]
        }
      }
    }
}